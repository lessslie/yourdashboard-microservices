import { 
  Controller, 
  Get, 
  Post, 
  Delete,
  Put,
  Body,
  Param,
  Req,
  Res,
  Query,
  UnauthorizedException,
  BadRequestException,
  HttpCode,
} from '@nestjs/common';
import { Request, Response } from 'express';
import { 
  ApiTags, 
  ApiOperation, 
  ApiOkResponse,
  ApiCreatedResponse,
  ApiBadRequestResponse,
  ApiUnauthorizedResponse,
  ApiNotFoundResponse,
  ApiConflictResponse,
  ApiBearerAuth,
  ApiBody,
  ApiParam,
  ApiQuery,
  ApiExcludeEndpoint,
  ApiInternalServerErrorResponse,
  ApiForbiddenResponse
} from '@nestjs/swagger';
import { AuthOrchestratorService } from './auth.service';
import { 
  AuthStartResponseDto, 
  AuthErrorResponseDto,
} from './dto';
import { LoginDto, RegisterDto } from './dto/auth-dto';
import { AuthResponseDto, CuentaGmailResponseDto, CuentasGmailResponseDto, ProfileResponseDto } from './dto/auth-response.dto';

@Controller('auth')
@ApiTags('Authentication')
export class AuthOrchestratorController {
  constructor(private readonly authService: AuthOrchestratorService) {}

  // ================================
  // üéØ ENDPOINTS TRADICIONALES
  // ================================

  /**
   * üìù POST /auth/register - Registrar nuevo usuario
   */
  @Post('register')
  @ApiOperation({ 
    summary: 'Registrar nuevo usuario',
    description: 'Crear una nueva cuenta con email y contrase√±a. Coordina con MS-Auth.' 
  })
  @ApiBody({ 
    type: RegisterDto,
    description: 'Datos del nuevo usuario'
  })
  @ApiCreatedResponse({ 
    description: 'Usuario registrado exitosamente',
    type: AuthResponseDto
  })
  @ApiBadRequestResponse({ 
    description: 'Datos inv√°lidos',
    type: AuthErrorResponseDto
  })
  @ApiConflictResponse({ 
    description: 'Email ya registrado',
    type: AuthErrorResponseDto 
  })
  async register(@Body() registerData: RegisterDto): Promise<AuthResponseDto> {
    console.log(`üîµ ORCHESTRATOR-AUTH - Registro solicitado para: ${registerData.email}`);
    return this.authService.register(registerData);
  }

  /**
   * üîë POST /auth/login - Iniciar sesi√≥n
   */
  @Post('login')
  @HttpCode(200)
 @ApiOperation({
  summary: 'üîë Iniciar sesi√≥n con perfil completo',
  description: `
    **Autenticaci√≥n optimizada que incluye:**
    
    - ‚úÖ Token JWT para autenticaci√≥n
    - üë§ Datos b√°sicos del usuario (compatibilidad)
    - üìß Lista completa de cuentas Gmail conectadas
    - üìä Estad√≠sticas de emails y eventos sincronizados
    - üîê Sesiones activas del usuario
    
    **Beneficio:** Elimina la necesidad de llamar a /auth/me despu√©s del login.
  `,
})
  @ApiBody({ 
    type: LoginDto,
    description: 'Credenciales de acceso'
  })
 @ApiOkResponse({
  description: 'Login exitoso con perfil completo - incluye token JWT, datos b√°sicos del usuario, cuentas Gmail asociadas y estad√≠sticas',
  type: AuthResponseDto,
})
  @ApiBadRequestResponse({ 
    description: 'Credenciales faltantes',
    type: AuthErrorResponseDto 
  })
  @ApiUnauthorizedResponse({ 
    description: 'Credenciales incorrectas',
    type: AuthErrorResponseDto 
  })
  async login(@Body() loginData: LoginDto): Promise<AuthResponseDto> {
    console.log(`üîµ ORCHESTRATOR-AUTH - Login solicitado para: ${loginData.email}`);
    return this.authService.login(loginData);
  }

  /**
   * üë§ GET /auth/me - Obtener perfil del usuario
   */
  @Get('me')
  @ApiBearerAuth('JWT-auth')
  @ApiOperation({
    summary: 'Obtener perfil del usuario',
    description: 'Obtiene la informaci√≥n del usuario autenticado con sus cuentas Gmail. Requiere JWT token.'
  })
  @ApiOkResponse({
    description: 'Perfil obtenido exitosamente',
    type: ProfileResponseDto
  })
  @ApiUnauthorizedResponse({
    description: 'Token faltante o inv√°lido',
    type: AuthErrorResponseDto
  })
  async getProfile(@Req() req: Request): Promise<ProfileResponseDto> {
    const authHeader = req.headers?.authorization;
    
    if (!authHeader) {
      throw new UnauthorizedException('Token de autorizaci√≥n requerido');
    }
    
    console.log(`üîµ ORCHESTRATOR-AUTH - Perfil solicitado`);
    return this.authService.getProfile(authHeader);
  }

  /**
   * üö™ POST /auth/logout - Cerrar sesi√≥n
   */
  @Post('logout')
  @ApiBearerAuth('JWT-auth')
  @ApiOperation({ 
    summary: 'Cerrar sesi√≥n',
    description: 'Invalida el JWT token actual. Coordina con MS-Auth.' 
  })
  @ApiOkResponse({ 
    description: 'Sesi√≥n cerrada exitosamente',
    schema: {
      type: 'object',
      properties: {
        success: { type: 'boolean', example: true },
        message: { type: 'string', example: 'Sesi√≥n cerrada exitosamente' }
      }
    }
  })
  @ApiUnauthorizedResponse({ 
    description: 'Token faltante o inv√°lido',
    type: AuthErrorResponseDto 
  })
  async logout(@Req() req: Request) {
    const authHeader = req.headers?.authorization;
    
    if (!authHeader) {
      throw new UnauthorizedException('Token de autorizaci√≥n requerido');
    }
    
    console.log(`üîµ ORCHESTRATOR-AUTH - Logout solicitado`);
    return this.authService.logout(authHeader);
  }

  // ================================
  // üéØ OAUTH GOOGLE
  // ================================

  @Get('start')
  @ApiOperation({ 
    summary: 'Iniciar proceso de autenticaci√≥n',
    description: 'Obtiene las URLs disponibles para iniciar OAuth con Google. Coordina con MS-Auth.'
  })
  @ApiOkResponse({ 
    description: 'URLs de autenticaci√≥n obtenidas exitosamente',
    type: AuthStartResponseDto
  })
  @ApiInternalServerErrorResponse({ 
    description: 'Error interno del orquestador',
    type: AuthErrorResponseDto 
  })
  startAuth(): AuthStartResponseDto {
    console.log(`üîµ ORCHESTRATOR-AUTH - Endpoint /auth/start llamado`);
    return this.authService.startAuthentication();
  }

  @Get('google')
  @ApiOperation({ 
    summary: 'Iniciar Google OAuth',
    description: 'Redirige al usuario a Google OAuth pasando el JWT token. Frontend debe incluir token en query param.'
  })
  @ApiQuery({
    name: 'token',
    description: 'JWT token del usuario autenticado',
    required: true,
    example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
  })
  @ApiOkResponse({ 
    description: 'Redirecci√≥n exitosa a Google OAuth',
    schema: {
      type: 'object',
      properties: {
        message: { 
          type: 'string', 
          example: 'Redirigiendo a Google OAuth...' 
        }
      }
    }
  })
  @ApiInternalServerErrorResponse({ 
    description: 'Error en redirecci√≥n',
    type: AuthErrorResponseDto 
  })
  redirectToGoogleAuth(
    @Query('token') token: string,
    @Res() res: Response,
    @Query('service') service?: string,
  ): void {
    if (!token) {
      throw new BadRequestException('Token JWT requerido como query parameter');
    }
    
    console.log(`üîµ ORCHESTRATOR-AUTH - Google OAuth solicitado`);
  console.log(`üéØ ORCHESTRATOR - Service: ${service || 'gmail (default)'}`);
  console.log(`üîç ORCHESTRATOR - Llamando getGoogleAuthUrlWithToken con: token=${!!token}, service=${service}`);

    
    const authUrl = this.authService.getGoogleAuthUrlWithToken(token, service);
    
    console.log(`üîµ ORCHESTRATOR-AUTH - Redirigiendo a: ${authUrl}`);
    res.redirect(authUrl);
  }

  @Get('google/callback')
  @ApiOperation({ 
    summary: 'Callback de Google OAuth',
    description: 'Maneja el callback de Google OAuth y redirige al MS-Auth para procesamiento.'
  })
  @ApiExcludeEndpoint()
  handleGoogleCallback(@Req() req: Request, @Res() res: Response): void {
    console.log(`üîµ ORCHESTRATOR-AUTH - Endpoint /auth/google/callback llamado`);
    this.authService.handleGoogleCallback(req, res);
  }

  // ================================
  // üìß GESTI√ìN DE CUENTAS GMAIL
  // ================================

  /**
   * üìß GET /auth/cuentas-gmail - Listar cuentas Gmail
   */
  @Get('cuentas-gmail')
  @ApiBearerAuth('JWT-auth')
  @ApiOperation({
    summary: 'Listar cuentas Gmail del usuario',
    description: 'Obtiene todas las cuentas Gmail conectadas del usuario principal autenticado. Coordina con MS-Auth.'
  })
  @ApiOkResponse({
    description: 'Lista de cuentas Gmail obtenida exitosamente',
    type: CuentasGmailResponseDto
  })
  @ApiUnauthorizedResponse({
    description: 'Token faltante o inv√°lido',
    type: AuthErrorResponseDto,
    
  })
  async listarCuentasGmail(@Req() req: Request): Promise<CuentasGmailResponseDto> {
    const authHeader = req.headers?.authorization;
    
    if (!authHeader) {
      throw new UnauthorizedException('Token de autorizaci√≥n requerido');
    }
    
    console.log(`üîµ ORCHESTRATOR-AUTH - Listado de cuentas Gmail solicitado`);
    return this.authService.getCuentasGmail(authHeader);
  }

  /**
   * üìß GET /auth/cuentas-gmail/:id - Obtener cuenta Gmail espec√≠fica
   */
  @Get('cuentas-gmail/:id')
  @ApiBearerAuth('JWT-auth')
  @ApiOperation({
    summary: 'Obtener cuenta Gmail espec√≠fica',
    description: 'Obtiene los detalles de una cuenta Gmail espec√≠fica del usuario. Coordina con MS-Auth.'
  })
  @ApiParam({
    name: 'id',
    description: 'ID de la cuenta Gmail',
    example: 'e5a3d40e-3700-4f7a-b962-e789ed794ce0'
  })
  @ApiOkResponse({
    description: 'Cuenta Gmail obtenida exitosamente',
    type: CuentaGmailResponseDto
  })
  @ApiNotFoundResponse({
    description: 'Cuenta Gmail no encontrada',
    type: AuthErrorResponseDto
  })
  async obtenerCuentaGmail(
    @Req() req: Request,
    @Param('id') cuentaId: string
  ): Promise<CuentaGmailResponseDto> {
    const authHeader = req.headers?.authorization;
    
    if (!authHeader) {
      throw new UnauthorizedException('Token de autorizaci√≥n requerido');
    }
    
    console.log(`üîµ ORCHESTRATOR-AUTH - Cuenta Gmail ${cuentaId} solicitada`);
    return this.authService.getCuentaGmail(authHeader, cuentaId);
  }


  /**
   * üóëÔ∏è DELETE /auth/cuentas-gmail/{id} - Desconectar cuenta Gmail
   */
  @Delete('cuentas-gmail/:id')
  @ApiBearerAuth('JWT-auth')
  @ApiOperation({
    summary: 'Desconectar cuenta Gmail',
    description: 'Desconecta y elimina una cuenta Gmail espec√≠fica del usuario. Coordina con MS-Auth.'
  })
  @ApiParam({
    name: 'id',
    description: 'ID de la cuenta Gmail a desconectar',
    example: 'c7c1c4b7-04a1-4350-9c39-c1d165de88c8'
  })
  @ApiOkResponse({
    description: 'Cuenta Gmail desconectada exitosamente',
    schema: {
      type: 'object',
      properties: {
        success: { type: 'boolean', example: true },
        message: { type: 'string', example: 'Cuenta Gmail desconectada exitosamente' }
      }
    }
  })
  @ApiUnauthorizedResponse({
    description: 'Token faltante o inv√°lido',
    type: AuthErrorResponseDto
  })
  @ApiNotFoundResponse({
    description: 'Cuenta Gmail no encontrada',
    type: AuthErrorResponseDto
  })
  async desconectarCuentaGmail(
    @Req() req: Request,
    @Param('id') cuentaId: string
  ) {
    const authHeader = req.headers?.authorization;
    
    if (!authHeader) {
      throw new UnauthorizedException('Token de autorizaci√≥n requerido');
    }
    
    console.log(`üîµ ORCHESTRATOR-AUTH - Desconexi√≥n cuenta Gmail ${cuentaId} solicitada`);
    return this.authService.desconectarCuentaGmail(authHeader, cuentaId);
  }

  /**
   * üóëÔ∏è DELETE /auth/users/{id} - Eliminar usuario principal completamente
   */
  @Delete('users/:id')
  @ApiBearerAuth('JWT-auth')
  @ApiOperation({
    summary: 'Eliminar usuario principal completamente',
    description: `
      **‚ö†Ô∏è OPERACI√ìN DESTRUCTIVA ‚ö†Ô∏è**
      
      Elimina completamente al usuario principal y TODA su data asociada:
      - ‚úÖ Usuario principal
      - ‚úÖ Todas las cuentas Gmail asociadas  
      - ‚úÖ Todos los emails sincronizados
      - ‚úÖ Todos los eventos sincronizados
      - ‚úÖ Todas las sesiones JWT activas
      
      **Esta operaci√≥n NO se puede deshacer.**
      
      **Seguridad:** Solo el propio usuario puede eliminar su cuenta.
      
      **Coordina con MS-Auth** para realizar la eliminaci√≥n completa.
    `
  })
  @ApiParam({
    name: 'id',
    description: 'ID del usuario principal a eliminar',
    example: 'e5a3d40e-3700-4f7a-b962-e789ed794ce0'
  })
  @ApiOkResponse({
    description: 'Usuario eliminado completamente con estad√≠sticas detalladas',
    schema: {
      type: 'object',
      properties: {
        success: { type: 'boolean', example: true },
        source: { type: 'string', example: 'orchestrator' },
        message: { type: 'string', example: 'Usuario principal eliminado completamente' },
        usuario_eliminado: {
          type: 'object',
          properties: {
            id: { type: 'string', example: 'e5a3d40e-3700-4f7a-b962-e789ed794ce0' },
            email: { type: 'string', example: 'usuario@email.com' },
            nombre: { type: 'string', example: 'Usuario Ejemplo' },
            fecha_registro: { type: 'string', example: '2025-01-15T10:30:00Z' }
          }
        },
        data_eliminada: {
          type: 'object',
          properties: {
            cuentas_gmail: { type: 'number', example: 2 },
            emails_sincronizados: { type: 'number', example: 1547 },
            eventos_sincronizados: { type: 'number', example: 89 },
            sesiones_activas: { type: 'number', example: 3 },
            cuentas_gmail_eliminadas: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  id: { type: 'string' },
                  email_gmail: { type: 'string' }
                }
              },
              example: [
                { id: 'cuenta-uuid-1', email_gmail: 'personal@gmail.com' },
                { id: 'cuenta-uuid-2', email_gmail: 'trabajo@gmail.com' }
              ]
            }
          }
        },
        eliminado_en: { type: 'string', example: '2025-09-22T15:30:00Z' }
      }
    }
  })
  @ApiUnauthorizedResponse({
    description: 'Token faltante o inv√°lido',
    type: AuthErrorResponseDto
  })
  @ApiForbiddenResponse({
    description: 'Solo puedes eliminar tu propia cuenta',
    type: AuthErrorResponseDto
  })
  @ApiNotFoundResponse({
    description: 'Usuario no encontrado',
    type: AuthErrorResponseDto
  })
  @ApiInternalServerErrorResponse({
    description: 'Error interno del servidor',
    type: AuthErrorResponseDto
  })
  async deleteUser(
    @Req() req: Request,
    @Param('id') userId: string
  ) {
    const authHeader = req.headers?.authorization;
    
    if (!authHeader) {
      throw new UnauthorizedException('Token de autorizaci√≥n requerido');
    }
    
    console.log(`üîµ ORCHESTRATOR-AUTH - Eliminaci√≥n de usuario ${userId} solicitada`);
    return this.authService.deleteUser(authHeader, userId);
  }
  /**
   * üè∑Ô∏è PUT /auth/cuentas-gmail/:id/alias - Actualizar alias
   */
  @Put('cuentas-gmail/:id/alias')
  @ApiBearerAuth('JWT-auth')
  @ApiOperation({
    summary: 'Actualizar alias de cuenta Gmail',
    description: 'Actualiza el alias personalizado de una cuenta Gmail. Coordina con MS-Auth.'
  })
  @ApiParam({
      name: 'id',
    description: 'ID de la cuenta Gmail',
    example: 'e5a3d40e-3700-4f7a-b962-e789ed794ce0'
  })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        alias_personalizado: { 
          type: 'string', 
          example: 'Gmail Trabajo',
          description: 'Nuevo alias para la cuenta Gmail'
        }
      },
      required: ['alias_personalizado']
    }
  })
  @ApiOkResponse({
    description: 'Alias actualizado exitosamente',
    schema: {
      type: 'object',
      properties: {
        success: { type: 'boolean', example: true },
        message: { type: 'string', example: 'Alias actualizado exitosamente' },
        cuenta_actualizada: {
          type: 'object',
          properties: {
            id: { type: 'string', example: 'e5a3d40e-3700-4f7a-b962-e789ed794ce0' },
            email_gmail: { type: 'string', example: 'usuario@gmail.com' },
            alias_personalizado: { type: 'string', example: 'Gmail Trabajo' }
          }
        }
      }
    }
  })
  @ApiBadRequestResponse({
    description: 'Alias inv√°lido o faltante',
    type: AuthErrorResponseDto
  })
  async actualizarAliasCuenta(
    @Req() req: Request,
    @Param('id') cuentaId: string,
    @Body() body: { alias_personalizado: string }
  ) {
    const authHeader = req.headers?.authorization;
    
    if (!authHeader) {
      throw new UnauthorizedException('Token de autorizaci√≥n requerido');
    }
    
    if (!body.alias_personalizado || body.alias_personalizado.trim() === '') {
      throw new BadRequestException('alias_personalizado es requerido');
    }
    
    console.log(`üîµ ORCHESTRATOR-AUTH - Actualizaci√≥n de alias para cuenta ${cuentaId}`);
    return this.authService.actualizarAliasCuenta(authHeader, cuentaId, body);
  }

  /**
   * üìä GET /auth/health - Health check del m√≥dulo auth
   */
  @Get('health')
  @ApiOperation({ 
    summary: 'Estado del m√≥dulo de autenticaci√≥n',
    description: 'Verifica el estado del m√≥dulo de autenticaci√≥n y su conectividad con MS-Auth.'
  })
  @ApiOkResponse({ 
    description: 'Estado del m√≥dulo obtenido exitosamente',
    schema: {
      type: 'object',
      properties: {
        service: { type: 'string', example: 'orchestrator-auth-module' },
        status: { type: 'string', example: 'OK' },
        timestamp: { type: 'string', example: '2024-01-15T10:30:00Z' },
        msAuthConnection: {
          type: 'object',
          properties: {
            url: { type: 'string', example: 'http://localhost:3001' },
            status: { type: 'string', example: 'configured' }
          }
        }
      }
    }
  })
  getAuthHealth() {
    console.log(`üîµ ORCHESTRATOR-AUTH - Health check solicitado`);
    return this.authService.checkAuthHealth();
  }
}